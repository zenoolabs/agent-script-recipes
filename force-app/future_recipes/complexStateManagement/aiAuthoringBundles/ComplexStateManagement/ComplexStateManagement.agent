# ComplexStateManagement - Advanced State Manipulation
# This agent demonstrates complex object and list operations for sophisticated state management

config:
   agent_name: "ComplexStateManagement"
   agent_label: "ComplexStateManagement"
   description: "Manages a todo list with complex state operations"

variables:
   # Complex list of objects
   tasks: mutable object = {}
      description: "List of task objects with id, title, status, priority"

   # Nested object with multiple properties
   user_stats: mutable object = {}
      description: "User statistics object"

   # List of simple values for filtering
   priority_filter: mutable object = {}
      description: "Active priority filters (high, medium, low)"

   # Current task being edited
   current_task: mutable object = {}
      description: "Task currently being viewed or edited"

   # Task ID counter
   next_task_id: mutable number = 1
      description: "Auto-incrementing task ID"

system:
   messages:
      welcome: "Hi! I'm your task manager. I can help you create, organize, and track your tasks."
      error: "I had trouble with that operation. Let's try again."

   instructions: "You are a task management assistant. Help users stay organized and productive."

start_agent topic_selector:
   description: "Welcome users and begin task management"
   
   reasoning:
      instructions:|
         Select the tool that best matches the user's message and conversation history. If it's unclear, make your best guess.
      actions:
         begin_task_management: @utils.transition to @topic.task_management
            description: "Start managing tasks with complex state operations"

topic task_management:
   description: "Manages complex task list with state operations"

   actions:
      # Action that manipulates list and returns updated state
      save_tasks:
         description: "Persists task list to storage"
         inputs:
            tasks: list[object]
               description: "List of task objects to persist to storage, each containing id, title, status, and priority"
         outputs:
            success: boolean
               description: "Indicates whether the tasks were saved successfully"
            task_count: number
               description: "Total number of tasks that were saved"
         target: "flow://SaveTasks"

      # Action that calculates statistics
      calculate_stats:
         description: "Calculates task statistics"
         inputs:
            tasks: list[object]
               description: "List of task objects to calculate statistics from"
         outputs:
            stats: object
               description: "Statistics object containing metrics like completed_tasks, pending_tasks, and completion_rate"
         target: "flow://CalculateTaskStats"

   reasoning:
      instructions:->
         # Display current state
         | Task Manager Status:
         
         if @variables.tasks:
            | Tasks: {!@variables.tasks}
         else:
            | No tasks available
         
         | Completed: {!@variables.user_stats.completed_tasks}
           Pending: {!@variables.user_stats.pending_tasks}
           Completion rate: {!@variables.user_stats.completion_rate}%

         # Show filtered view if filters active
         if @variables.priority_filter:
            | Active filters: {!@variables.priority_filter}

              List operations:
              - Adding items to list
              - Removing items from list
              - Updating items in list
              - Filtering lists
              - Searching lists

         | Help the user manage their tasks:
           1. Add new tasks (creates object, adds to list, increments ID)
           2. Mark tasks complete (finds in list, updates status)
           3. Delete tasks (removes from list)
           4. Filter by priority (updates filter list)
           5. View task details (sets current_task object)
           6. Calculate statistics (calls action, updates stats object)

         | When adding a task, create an object with below properties like:
           "{"
              "id": {!@variables.next_task_id},
              "title": "task title from user",
              "status": "pending",
              "priority": "medium",
              "created": "timestamp"
           "}"

         | Operations you can guide user through:
           "Add task: [title]" → append to @variables.tasks list
           "Complete task [id]" → find and update in list
           "Delete task [id]" → remove from list
           "Show high priority" → filter list by priority
           "Calculate stats" → run {!@actions.calculate_stats}
           "Save changes" → run {!@actions.save_tasks}

      actions:
         # These would normally be implemented with actual list manipulation
         # In real agents, you'd use actions that handle the state changes
         save_tasks: @actions.save_tasks
            with tasks=...

         calculate_stats: @actions.calculate_stats
            with tasks=@variables.tasks
            set @variables.user_stats = @outputs.stats