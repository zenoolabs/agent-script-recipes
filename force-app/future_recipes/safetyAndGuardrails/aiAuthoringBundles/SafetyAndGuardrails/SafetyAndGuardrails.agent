# SafetyAndGuardrails - Production Safety Patterns
# This agent demonstrates comprehensive safety and confirmation patterns

config:
   agent_name: "SafetyAndGuardrails"
   agent_label: "SafetyAndGuardrails"
   description: "Handles sensitive data deletion with safety guardrails"

variables:
   record_id: mutable string = ""
      description: "Record ID to delete"

   record_type: mutable string = ""
      description: "Type of record"

   confirmation_received: mutable boolean = False
      description: "Whether user confirmed deletion"

   is_admin: mutable boolean = True
      description: "Whether user has admin privileges. Defaulting to True for demonstration."

   has_dependencies: mutable boolean = False
      description: "Whether record has dependencies"

   dependency_count: mutable number = 0
      description: "Number of dependent records"

system:
   messages:
      welcome: "I can help with data management. Deletions require confirmation."
      error: "Operation cancelled for safety."

   instructions: "You are a data management assistant. Prioritize data safety."

start_agent topic_selector:
   description: "Welcome users and begin data management with safety protocols"
   
   reasoning:
      instructions:|
         Select the tool that best matches the user's message and conversation history. If it's unclear, make your best guess.
      actions:
         begin_data_management: @utils.transition to @topic.data_management
            description: "Start data management with safety guardrails"

topic data_management:
   description: "Manages data with safety guardrails"

   actions:
      check_dependencies:
         description: "Checks if record has dependencies"
         inputs:
            record_id: string
               description: "The unique identifier of the record to check for dependencies"
         outputs:
            has_dependencies: boolean
               description: "Indicates whether the record has dependent records that would be affected by deletion"
            count: number
               description: "The number of dependent records that would be affected by deletion"
            record_type: string
               description: "The type of the record being checked"
         target: "flow://CheckDependencies"

      delete_record:
         description: "Deletes a record permanently"
         inputs:
            record_id: string
               description: "The unique identifier of the record to permanently delete"
            confirmed: boolean
               description: "Confirmation flag that must be true to proceed with deletion (safety check)"
         outputs:
            success: boolean
               description: "Indicates whether the record was deleted successfully"
         target: "flow://DeleteRecord"

   reasoning:
      instructions:->
         # Safety pattern: Multi-stage validation
         if not @variables.record_id:
            | Ask for record ID to delete.

         # Check dependencies first
         if @variables.record_id and not @variables.has_dependencies:
            run @actions.check_dependencies
               with record_id=@variables.record_id
               set @variables.has_dependencies = @outputs.has_dependencies
               set @variables.dependency_count = @outputs.count
               set @variables.record_type = @outputs.record_type

         # Warn about dependencies
         if @variables.has_dependencies and @variables.dependency_count > 0:
            | ⚠️ WARNING: This record has {!@variables.dependency_count} dependent records.
              Deleting it will affect:
              - {!@variables.dependency_count} related records
              - Data integrity
              - Related workflows

              Are you absolutely sure? Type "CONFIRM DELETE" to proceed.

         # Require explicit confirmation
         if not @variables.confirmation_received:
            | ⚠️ IMPORTANT: Deletion is permanent and cannot be undone.

              Record: {!@variables.record_id}
              Type: {!@variables.record_type}

              To proceed, please type "CONFIRM DELETE"

         # Only proceed if confirmed
         if @variables.confirmation_received:
            | Proceeding with deletion after confirmation.

      actions:
         # Safety: Require confirmation AND admin role
         delete_record: @actions.delete_record
            available when @variables.confirmation_received and @variables.is_admin
            with record_id=...
            with confirmed=True
         
         user_confirmation: @utils.setVariables
            with confirmation_received=True
