# ActionCallbacks - Post-Action Processing
# This agent demonstrates running code after actions complete

config:
   agent_name: "ActionCallbacks"
   agent_label: "ActionCallbacks"
   description: "Processes payments with post-action callbacks"

variables:
   payment_amount: mutable number = 0
      description: "Payment amount"

   payment_method: mutable string = ""
      description: "Payment method used"

   transaction_id: mutable string = ""
      description: "Transaction ID from payment"

   payment_successful: mutable boolean = False
      description: "Whether payment succeeded"

   receipt_sent: mutable boolean = False
      description: "Whether receipt was sent"

   points_awarded: mutable number = 0
      description: "Loyalty points awarded"

system:
   messages:
      welcome: "I'll help you process your payment securely."
      error: "Payment processing error. Please try again."

   instructions: "You are a payment processor. Handle transactions securely and provide confirmations."

start_agent topic_selector:
   description: "Welcome users and begin payment processing"
   
   reasoning:
      instructions:|
         Select the tool that best matches the user's message and conversation history. If it's unclear, make your best guess.
      actions:
         begin_payment: @utils.transition to @topic.payment_processing
            description: "Start processing payments with post-action callbacks"

topic payment_processing:
   description: "Processes payments with callbacks"

   actions:
      process_payment:
         description: "Processes a payment transaction"
         inputs:
            amount: number
               description: "The payment amount to be processed"
            method: string
               description: "The mode of the payment"
         outputs:
            transaction_id: string
               description: "Unique identifier for the completed transaction"
            success: boolean
               description: "Indicates whether the payment was processed successfully"
         target: "flow://ProcessPayment"

      send_receipt:
         description: "Sends payment receipt"
         inputs:
            transaction_id: string
               description: "The transaction ID to include in the receipt"
            amount: number
               description: "The payment amount to display on the receipt"
         outputs:
            sent: boolean
               description: "Indicates whether the receipt was sent successfully"
         target: "flow://SendReceipt"

      award_points:
         description: "Awards loyalty points"
         inputs:
            amount: number
               description: "The payment amount used to calculate loyalty points"
         outputs:
            points: number
               description: "The number of loyalty points awarded to the customer"
         target: "flow://AwardLoyaltyPoints"

      log_transaction:
         description: "Logs transaction for audit"
         inputs:
            transaction_id: string
               description: "The transaction ID to be logged for audit purposes"
         outputs:
            success: boolean
               description: "Indicates whether the transaction was logged successfully"
         target: "flow://LogTransaction"

   reasoning:
      instructions:->
         | Process payments and handle post-payment tasks.

           Status:
           - Amount: ${!@variables.payment_amount}
           - Method: {!@variables.payment_method}
         
         if @variables.transaction_id:
            | - Transaction: {!@variables.transaction_id}
         else:
            | - Transaction: None
         
         | - Success: {!@variables.payment_successful}
           - Receipt sent: {!@variables.receipt_sent}
           - Points: {!@variables.points_awarded}

           Guide user through payment process.

           Store the amount first, then process the payment.

      actions:
         # Action to store the amount for the callbacks to use
         set_amount: @utils.setVariables
            with payment_amount=...
          # Main action with multiple callbacks
         make_payment: @actions.process_payment
            with amount=...
            with method=...
            # Capture outputs
            set @variables.transaction_id = @outputs.transaction_id
            set @variables.payment_successful = @outputs.success
            # Run callback action 1: Send receipt
            run @actions.send_receipt
               with transaction_id=@variables.transaction_id
               with amount=@variables.payment_amount
               set @variables.receipt_sent = @outputs.sent
            # Run callback action 2: Award points
            run @actions.award_points
               with amount=@variables.payment_amount
               set @variables.points_awarded = @outputs.points
            # Run callback action 3: Log transaction
            run @actions.log_transaction
               with transaction_id=@variables.transaction_id
